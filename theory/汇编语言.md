# 汇编语言

[TOC]



## 基础知识

汇编语言产生原因：用于记忆机器语言



汇编语言组成：

- 汇编指令：机器码的助记符 有对应的机器码
- 伪指令：没有对应的机器码
- 其他符号：没有对应的机器码



**CPU对存储器的读写**

1. 地址线：指定存储单元的地址，宽度决定了CPU的寻址能力 
2. 控制线：指定读或者写的命令，宽度决定了对其他器件的控制能力
3. 数据线：传输读或者写的信息，宽度决定了一次的数据传送量



## 寄存器

物理地址 = 段地址 * 16 (基础地址) + 偏移地址

 

CPU当前要执行的指令: CS:IP  段:偏移

```assembly
# 同时修改CS和IP的值 需要用到转移指令
jmp 1000:0 
# 执行后 CS=1000H IP=0000H CPU将从10000H处读取指令
```



读取内存中的数据

```assembly
mov bx, 1000H
mov ds, bx
mov al, [0] #[address]表示内存地址中的偏移地址 段地址为ds中的值 且ds不能直接赋值 需要通过寄存器间接赋值

```



内存中不管是指令还是数据都是二进制

- 代码段：CS:IP指向的地方
- 数据段：ds:[address] 指向的地方



栈：可以将内存中的一段空间作为栈来使用

SS:SP指向的位置为栈顶 若栈的空间为 00000H-0000FH（从高位到低位增长） 则栈顶指针初始位置为00010H 

```assembly
push ax # 将寄存器ax的数据压入内存的栈中
pop ax # 将内存中栈的数据弹出放入ax中
```





```assembly
assume cs:abc

abc segment
	mov ax 
```



## [bx]和loop指令

[bx]表示一个内存单元，bx是偏移地址，段地址在ds中

```assembly
mov ax,[bx]
```



```assembly
mov ax,2
mov cx,11
s: add ax,ax
	 loop s
# loop的含义 遇到loop时 if(--cx == 0) 向下执行 否则跳转到s   
```



段前缀，可以显示指定段地址

```assembly
mov ax,ds:[bx]
mov ax,cs:[bx]
```



## 包含多个段的程序

数据 代码 栈分别放入同一个段的问题

- 组织混乱
- 一个段的空间有限



数据 代码 栈放入不同的段中

```assembly
# 代码 数据 栈 
assume cs:code,ds:data,ss:stack
data segment
data ends

stack segment
stack ends

code segment
start: 
code ends

# 指定指令开始的地方
end start
```





## 数据处理的两个基本问题

基本问题：

- 处理的数据在什么地方
- 要处理的数据有多长



## 转移指令的原理

转移指令：修改IP或者同时修改CS:IP的指令

```assembly
jmp 标号

jcxz # 如果cx = 0 就跳转到标号出

loop # 用的是位移
```



根据位移进行转移的意义：

程序放到不同的物理地址都能正确执行



## CALL和RET指令

```assembly
CALL：
push IP
jmp 标号

push CS
push IP
jmp 标号

ret: pop IP # 将数据从内存中加载到寄存器IP中
retf: 
pop IP 
pop CS
```



程序与子程序之间的数据传递：

- 寄存器

  为了避免寄存器冲突

  子程序开始的时候将自己用到的寄存器入栈

  结束的时候寄存器出栈

- 内存






## 标志寄存器

按位起作用，通常与条件转移指令相关

```assembly
# 标志寄存器的值入栈
pushf
# 从栈中弹出值到标志寄存器
popf
```



## 内中断

CPU内部产生需要马上处理的中断信息的场景：

- 除法错误
- 单步执行
- 执行into指令
- 执行int指令



中断向量表：中断类型码 -> 中断处理程序的入口地址



中断过程：

1. 从中断信息中获取中断类型码
2. 标志寄存器的值入栈（因为接下来要改变标志寄存器的值）
3. 设置标志寄存器的值
4. CS入栈 IP入栈
5. 从中断向量表取出地址 设置CS:IP 



## int指令

属于内中断的一种

int n n就是中断类型码





## 端口

端口就是接口芯片中的寄存器

CPU可以直接读写

- CPU内部的寄存器
- 内存单元
- 端口



## 外中断

当外设有需要CPU及时处理的事件时，CPU在执行完当前指令后，可以检测得到发送过来的中断信息，引发中断过程

外中断源类型：

- 可屏蔽中断：

  需要先检测标志寄存器中的IF=1 就响应中断

  否则不响应

  外设引发的中断大部分都是可屏蔽中断

- 不可屏蔽中断：

  必须立即响应